app-id: io.github.benjamimgois.goverlay
runtime: org.kde.Platform
runtime-version: '5.15-21.08'
sdk: org.kde.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.freepascal
build-options:
  append-path: /usr/lib/sdk/freepascal/bin
  env:
    LAZARUS_DIR: /usr/lib/sdk/freepascal/share/lazarus
command: goverlay
add-extensions:
  com.valvesoftware.Steam.Utility:
    subdirectories: true
    directory: utils
    version: stable
    versions: stable;beta;test
    add-ld-path: lib
    merge-dirs: bin
    no-autodownload: true
    autodelete: true

finish-args:
  - --share=ipc
  - --socket=pulseaudio
  - --socket=x11
  - --device=dri
  - --share=network
  - --filesystem=xdg-config/MangoHud

modules:
  - name: qt5pas
    config-opts:
      - -after
      - target.path=/app/lib
    buildsystem: qmake
    sources:
      - type: shell
        commands:
          - cp -r /usr/lib/sdk/freepascal/share/lazarus/lcl/interfaces/qt5/cbindings/.
            .

  - name: libglu
    buildsystem: meson
    cleanup:
      - /include
      - /lib/debug
      - /lib/pkgconfig
      - /lib/*.a
    sources:
      - type: archive
        url: https://mesa.freedesktop.org/archive/glu/glu-9.0.2.tar.xz
        sha256: 6e7280ff585c6a1d9dfcdf2fca489251634b3377bfc33c29e4002466a38d02d4
        x-checker-data:
          type: anitya
          project-id: 13518
          stable-only: true
          url-template: https://mesa.freedesktop.org/archive/glu/glu-$version.tar.xz

  - name: goverlay
    buildsystem: simple
    build-commands:
      - . /usr/lib/sdk/freepascal/enable.sh && lazbuild -B --lazarusdir="$LAZARUS_DIR" goverlay.lpi
      - make -j$FLATPAK_BUILDER_N_JOBS
      - make install
    sources:
      - type: git
        url: https://github.com/benjamimgois/goverlay.git
        tag: 0.8.1
        commit: e955035a21d3b04bbf157087bf525ae218bd8075
      - type: patch
        path: patches/0001-Use-app-prefix.patch
      - type: patch
        path: patches/0002-Change-mangohud-path.patch
